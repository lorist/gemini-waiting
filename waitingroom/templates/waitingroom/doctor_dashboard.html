{# waitingroom/templates/waitingroom/doctor_dashboard.html #}
{% extends 'base.html' %} {# This line tells Django to use base.html as the parent #}

{% block title %}Dr. {{ doctor.name }}'s Dashboard - My App{% endblock %}

{% block content %}
    <div class="container mx-auto p-6 card">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">Dr. <span id="doctorName">{{ doctor.name }}</span>'s Waiting Room</h1>

        <div class="mb-6 p-4 border border-gray-200 rounded-lg bg-gray-50 flex flex-col sm:flex-row items-center justify-between gap-4">
            <input type="text" id="newPatientName" placeholder="Enter new patient name" class="flex-grow p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            <button id="addPatientBtn" class="bg-blue-600 text-white px-6 py-3 rounded-md font-semibold hover:bg-blue-700 transition duration-200 ease-in-out shadow-md">Add Patient to Queue</button>
        </div>

        <div id="waitingList" class="space-y-4">
            <!-- Waiting room entries will be dynamically inserted here -->
            <p class="text-center text-gray-500" id="loadingMessage">Loading waiting list...</p>
        </div>

        <!-- Button to History Page -->
        <div class="mt-8 text-center">
            <a href="{% url 'doctor_history' doctor.id %}" class="inline-block bg-gray-700 text-white px-6 py-3 rounded-md font-semibold hover:bg-gray-800 transition duration-200 ease-in-out shadow-md">
                View Patient History
            </a>
        </div>

        <!-- Chat Section -->
        <div id="chatSection" class="mt-8 p-6 card hidden">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">Chat with <span id="chatPatientName"></span></h2>
            <div id="chatMessages" class="bg-gray-100 p-4 rounded-md h-64 overflow-y-auto mb-4 space-y-2">
                <!-- Chat messages will appear here -->
            </div>
            <div class="flex gap-2">
                <input type="text" id="chatInput" placeholder="Type your message..." class="flex-grow p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button id="sendChatBtn" class="bg-blue-600 text-white px-4 py-2 rounded-md font-semibold hover:bg-blue-700 transition duration-200 ease-in-out shadow-md">Send</button>
            </div>
        </div>

        <!-- Whiteboard Section -->
        <div id="whiteboardSection" class="mt-8 p-6 card hidden">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">Shared Whiteboard with <span id="whiteboardPatientName"></span></h2>
            <div class="flex flex-wrap gap-2 mb-4 justify-center">
                <button class="whiteboard-color-button w-8 h-8 rounded-full border-2 border-gray-300" style="background-color: black;" data-color="black"></button>
                <button class="whiteboard-color-button w-8 h-8 rounded-full border-2 border-gray-300" style="background-color: red;" data-color="red"></button>
                <button class="whiteboard-color-button w-8 h-8 rounded-full border-2 border-gray-300" style="background-color: blue;" data-color="blue"></button>
                <button class="whiteboard-color-button w-8 h-8 rounded-full border-2 border-gray-300" style="background-color: green;" data-color="green"></button>
                <button id="clearWhiteboardBtn" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-md font-semibold hover:bg-gray-300 transition duration-200">Clear</button>
            </div>
            <canvas id="whiteboardCanvas" class="border border-gray-300 rounded-md bg-white w-full" style="aspect-ratio: 16 / 9;"></canvas>
        </div>


        <!-- Custom Modal for Alerts/Confirmations -->
        <div id="customModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden">
            <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full">
                <h3 id="modalTitle" class="text-lg font-bold mb-4"></h3>
                <p id="modalMessage" class="mb-6"></p>
                <div class="flex justify-end space-x-3">
                    <button id="modalCancelBtn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition duration-200 hidden">Cancel</button>
                    <button id="modalConfirmBtn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition duration-200">OK</button>
                </div>
            </div>
        </div>

        <!-- Toast Notification -->
        <div id="toastNotification" class="fixed bottom-4 right-4 bg-gray-800 text-white px-4 py-2 rounded-md shadow-lg hidden">
            Link copied to clipboard!
        </div>

    </div>
{% endblock %}

{% block extra_js %}
    <script>
        const doctorId = "{{ doctor.id }}";
        const doctorNameElement = document.getElementById('doctorName');
        const waitingListDiv = document.getElementById('waitingList');
        const loadingMessage = document.getElementById('loadingMessage');
        const newPatientNameInput = document.getElementById('newPatientName');
        const addPatientBtn = document.getElementById('addPatientBtn');

        // Pexip settings passed from Django context
        const PEXIP_ADDRESS = "{{ pexip_address }}";
        const PEXIP_PATH = "{{ pexip_path }}";

        // Modal elements
        const customModal = document.getElementById('customModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');
        const modalConfirmBtn = document.getElementById('modalConfirmBtn');
        const modalCancelBtn = document.getElementById('modalCancelBtn');

        // Toast Notification element
        const toastNotification = document.getElementById('toastNotification');

        // Chat elements
        const chatSection = document.getElementById('chatSection');
        const chatPatientNameSpan = document.getElementById('chatPatientName');
        const chatMessagesDiv = document.getElementById('chatMessages');
        const chatInput = document.getElementById('chatInput');
        const sendChatBtn = document.getElementById('sendChatBtn');

        // Whiteboard elements
        const whiteboardSection = document.getElementById('whiteboardSection');
        const whiteboardPatientNameSpan = document.getElementById('whiteboardPatientName');
        const whiteboardCanvas = document.getElementById('whiteboardCanvas');
        const clearWhiteboardBtn = document.getElementById('clearWhiteboardBtn');
        const whiteboardColorButtons = document.querySelectorAll('.whiteboard-color-button');
        let ctx = whiteboardCanvas.getContext('2d');
        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;
        let drawColor = 'black'; // Default drawing color
        let activeWhiteboardPatientUuid = null; // To track which patient's whiteboard is active

        let activeChatPatientUuid = null; // To track which patient the doctor is currently chatting with
        const unreadMessages = {}; // Store unread message counts per patient UUID
        const patientChatHistories = {}; // Store chat history for each patient

        function showCustomModal(title, message, onConfirm = null, onCancel = null) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            customModal.classList.remove('hidden');

            modalConfirmBtn.onclick = () => {
                customModal.classList.add('hidden');
                if (onConfirm) onConfirm();
            };

            if (onCancel) {
                modalCancelBtn.classList.remove('hidden');
                modalCancelBtn.onclick = () => {
                    customModal.classList.add('hidden');
                    onCancel();
                };
            } else {
                modalCancelBtn.classList.add('hidden');
            }
        }

        function showToast(message) {
            toastNotification.textContent = message;
            toastNotification.classList.remove('hidden');
            setTimeout(() => {
                toastNotification.classList.add('hidden');
            }, 3000); // Hide after 3 seconds
        }

        // WebSocket connection
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${window.location.host}/ws/waiting_room/${doctorId}/`;
        const chatSocket = new WebSocket(wsUrl);

        chatSocket.onopen = function(e) {
            console.log("WebSocket connection opened.");
            doctorNameElement.textContent = `Dr. {{ doctor.name }}`;
            loadingMessage.textContent = "Connected. Waiting for updates...";
            resizeCanvas(); // Set initial canvas size
        };

        chatSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            console.log("Received message:", data);

            if (data.type === 'waiting_list') {
                updateWaitingListUI(data.data);
            } else if (data.type === 'chat_message') {
                // Store message in history first
                if (!patientChatHistories[data.patient_uuid]) {
                    patientChatHistories[data.patient_uuid] = [];
                }
                patientChatHistories[data.patient_uuid].push({
                    sender: data.sender,
                    message: data.message,
                    timestamp: new Date().toLocaleTimeString()
                });

                displayChatMessage(data.sender, data.message, data.patient_uuid);
            } else if (data.type === 'drawing_data') {
                if (activeWhiteboardPatientUuid === data.patient_uuid) {
                    drawOnCanvas(data.data);
                }
            } else if (data.type === 'whiteboard_history') { // NEW: Handle incoming whiteboard history
                if (activeWhiteboardPatientUuid === data.patient_uuid) {
                    // Clear canvas before drawing history
                    ctx.clearRect(0, 0, whiteboardCanvas.width, whiteboardCanvas.height);
                    data.data.forEach(drawingCommand => {
                        drawOnCanvas(drawingCommand);
                    });
                }
            } else if (data.type === 'error') {
                showCustomModal('Error', data.message);
            }
        };

        chatSocket.onclose = function(e) {
            console.error('WebSocket closed unexpectedly:', e);
            loadingMessage.textContent = "Disconnected. Please refresh.";
            showCustomModal('Disconnected', 'The connection to the waiting room updates has been lost. Please refresh the page.');
        };

        chatSocket.onerror = function(e) {
            console.error('WebSocket error:', e);
            loadingMessage.textContent = "Error connecting. Please refresh.";
            showCustomModal('Connection Error', 'An error occurred with the WebSocket connection. Please refresh the page.');
        };

        function displayChatMessage(sender, message, patientUuid) {
            if (sender !== `Dr. {{ doctor.name }}` && activeChatPatientUuid !== patientUuid) {
                unreadMessages[patientUuid] = (unreadMessages[patientUuid] || 0) + 1;
                updateChatAlert(patientUuid);
            }

            if (activeChatPatientUuid === patientUuid) {
                appendMessageToChatDiv(sender, message);
            }
        }

        function updateChatAlert(patientUuid) {
            const chatButton = document.querySelector(`.chat-toggle-button[data-patient-uuid="${patientUuid}"]`);
            if (chatButton) {
                let alertBadge = chatButton.querySelector('.chat-alert-badge');
                if (!alertBadge) {
                    alertBadge = document.createElement('span');
                    alertBadge.className = 'chat-alert-badge absolute top-0 right-0 -mt-1 -mr-1 bg-red-500 text-white text-xs font-bold px-2 py-1 rounded-full';
                    chatButton.style.position = 'relative';
                    chatButton.appendChild(alertBadge);
                }
                const count = unreadMessages[patientUuid] || 0;
                if (count > 0) {
                    alertBadge.textContent = count;
                    alertBadge.classList.remove('hidden');
                } else {
                    alertBadge.classList.add('hidden');
                }
            }
        }

        function updateWhiteboardAlert(patientUuid, isActive) {
            const whiteboardButton = document.querySelector(`.whiteboard-toggle-button[data-patient-uuid="${patientUuid}"]`);
            if (whiteboardButton) {
                let alertBadge = whiteboardButton.querySelector('.whiteboard-active-badge');
                if (!alertBadge) {
                    alertBadge = document.createElement('span');
                    alertBadge.className = 'whiteboard-active-badge absolute top-0 right-0 -mt-1 -mr-1 bg-blue-500 text-white text-xs font-bold px-2 py-1 rounded-full';
                    whiteboardButton.style.position = 'relative';
                    whiteboardButton.appendChild(alertBadge);
                }
                if (isActive) {
                    alertBadge.textContent = 'Active'; // Or a simple dot/icon
                    alertBadge.classList.remove('hidden');
                } else {
                    alertBadge.classList.add('hidden');
                }
            }
        }


        sendChatBtn.onclick = function() {
            const message = chatInput.value.trim();
            if (message && activeChatPatientUuid) {
                chatSocket.send(JSON.stringify({
                    'type': 'chat_message',
                    'sender': `Dr. {{ doctor.name }}`,
                    'message': message,
                    'patient_uuid': activeChatPatientUuid
                }));
                chatInput.value = '';
            }
        };

        chatInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendChatBtn.click();
            }
        });


        function updateWaitingListUI(waitingList) {
            waitingListDiv.innerHTML = '';
            if (waitingList.length === 0) {
                waitingListDiv.innerHTML = '<p class="text-center text-gray-500">No patients in the waiting room.</p>';
                // NEW: If no patients, ensure whiteboard is hidden
                whiteboardSection.classList.add('hidden');
                activeWhiteboardPatientUuid = null;
                return;
            }

            let foundActiveWhiteboardPatient = false; // NEW: Flag to track if the active whiteboard patient is still in an active status

            waitingList.forEach(entry => {
                const entryCard = document.createElement('div');
                entryCard.className = 'card p-4 flex flex-col sm:flex-row items-center justify-between space-y-3 sm:space-y-0 sm:space-x-4';
                entryCard.innerHTML = `
                    <div class="flex-grow text-center sm:text-left">
                        <p class="text-xl font-semibold text-gray-900">${entry.patient_name}</p>
                        <p class="text-sm text-gray-600">Arrived: ${entry.arrived_at}</p>
                        <p class="text-xs text-gray-400">UUID: ${entry.patient_uuid}</p>
                        ${entry.host_pin ? `<p class="text-sm text-gray-700">Host PIN: <span class="font-bold">${entry.host_pin}</span></p>` : ''}
                        ${entry.guest_pin ? `<p class="text-sm text-gray-700">Guest PIN: <span class="font-bold">${entry.guest_pin}</span></p>` : ''}
                    </div>
                    <div class="flex flex-wrap justify-center sm:justify-end gap-2">
                        <button data-id="${entry.id}" data-status="Waiting" class="status-interactive-button status-waiting ${entry.status === 'Waiting' ? 'opacity-100' : 'opacity-50'}">Waiting</button>
                        <button data-id="${entry.id}" data-status="In Progress" class="status-interactive-button status-in-progress ${entry.status === 'In Progress' ? 'opacity-100' : 'opacity-50'}">In Progress</button>
                        <span class="status-display status-in-call ${entry.status === 'In Call' ? 'opacity-100' : 'opacity-50'}">In Call</span>
                        <button data-id="${entry.id}" data-status="Done" class="status-interactive-button status-done ${entry.status === 'Done' ? 'opacity-100' : 'opacity-50'}">Done</button>
                        <button data-id="${entry.id}" data-status="Cancelled" data-action="remove" class="status-interactive-button status-cancelled ${entry.status === 'Cancelled' ? 'opacity-100' : 'opacity-50'}">Remove</button>
                        ${entry.status === 'In Progress' || entry.status === 'In Call' ? `
                            <button data-patient-uuid="${entry.patient_uuid}" data-host-pin="${entry.host_pin}" data-patient-name="${entry.patient_name}" class="connect-button bg-purple-600 text-white px-4 py-2 rounded-md font-semibold hover:bg-purple-700 transition duration-200 ease-in-out shadow-md">
                                Connect
                            </button>
                        ` : ''}
                        ${entry.added_by_doctor && (entry.status === 'In Progress' || entry.status === 'In Call') ? `
                            <button class="copy-link-button bg-gray-500 text-white px-4 py-2 rounded-md font-semibold hover:bg-gray-600 transition duration-200 ease-in-out shadow-md"
                                    data-patient-uuid="${entry.patient_uuid}"
                                    data-patient-name="${entry.patient_name}"
                                    data-guest-pin="${entry.guest_pin}">
                                Copy Patient Link
                            </button>
                        ` : ''}
                        <button data-patient-uuid="${entry.patient_uuid}" data-patient-name="${entry.patient_name}" class="chat-toggle-button bg-green-500 text-white px-4 py-2 rounded-md font-semibold hover:bg-green-600 transition duration-200 ease-in-out shadow-md">Chat</button>
                        ${entry.status === 'In Progress' || entry.status === 'In Call' ? `
                            <button data-patient-uuid="${entry.patient_uuid}" data-patient-name="${entry.patient_name}" class="whiteboard-toggle-button bg-indigo-500 text-white px-4 py-2 rounded-md font-semibold hover:bg-indigo-600 transition duration-200 ease-in-out shadow-md">Whiteboard</button>
                        ` : ''}
                    </div>
                `;
                waitingListDiv.appendChild(entryCard);
                updateChatAlert(entry.patient_uuid);
                updateWhiteboardAlert(entry.patient_uuid, entry.whiteboard_active); // Update whiteboard badge

                // NEW: Check if the currently active whiteboard patient is still in an active status
                if (activeWhiteboardPatientUuid === entry.patient_uuid && (entry.status === 'In Progress' || entry.status === 'In Call')) {
                    foundActiveWhiteboardPatient = true;
                }
            });

            // NEW: If the previously active whiteboard patient is no longer in an active status, hide the whiteboard
            if (activeWhiteboardPatientUuid && !foundActiveWhiteboardPatient) {
                whiteboardSection.classList.add('hidden');
                activeWhiteboardPatientUuid = null;
            }


            document.querySelectorAll('.status-interactive-button').forEach(button => {
                button.onclick = function() {
                    const entryId = this.dataset.id;
                    const action = this.dataset.action;
                    const patientNameElement = this.closest('.card').querySelector('.text-xl.font-semibold');
                    const patientName = patientNameElement ? patientNameElement.textContent : 'Unknown Patient';

                    if (action === 'remove') {
                        showCustomModal(
                            'Confirm Removal',
                            `Are you sure you want to remove patient "${patientName}" from the queue? This action cannot be undone.`,
                            () => {
                                chatSocket.send(JSON.stringify({
                                    'type': 'remove_patient',
                                    'entry_id': entryId
                                }));
                            },
                            () => {
                                console.log("Patient removal cancelled.");
                            }
                        );
                    } else {
                        const newStatus = this.dataset.status;
                        showCustomModal(
                            'Confirm Status Change',
                            `Are you sure you want to change the status of patient "${patientName}" to "${newStatus}"?`,
                            () => {
                                chatSocket.send(JSON.stringify({
                                    'type': 'update_status',
                                    'entry_id': entryId,
                                    'status': newStatus
                                }));
                            },
                            () => {
                                console.log("Status change cancelled.");
                            }
                        );
                    }
                };
            });

            document.querySelectorAll('.connect-button').forEach(button => {
                button.onclick = function() {
                    const patientUuid = this.dataset.patientUuid;
                    const hostPin = this.dataset.hostPin;
                    const patientName = this.dataset.patientName;

                    showCustomModal(
                        'Connect to Patient',
                        `Connect to ${patientName}'s virtual room?`,
                        () => {
                            const pexipUrl = `https://${PEXIP_ADDRESS}/${PEXIP_PATH}/m/?conference=${patientUuid}&name=${encodeURIComponent(`Dr. {{ doctor.name }}`)}&role=host&pin=${hostPin}`;
                            window.open(pexipUrl, '_blank');
                        },
                        () => {
                            console.log("Connect to patient cancelled.");
                        },
                        'Connect',
                        'Cancel'
                    );
                };
            });

            document.querySelectorAll('.copy-link-button').forEach(button => {
                button.onclick = function() {
                    const patientUuid = this.dataset.patientUuid;
                    const patientName = this.dataset.patientName;
                    const guestPin = this.dataset.guestPin;

                    const patientJoinLink = `https://${PEXIP_ADDRESS}/${PEXIP_PATH}/m/?conference=${patientUuid}&name=${encodeURIComponent(patientName)}&role=guest&pin=${guestPin}`;

                    const tempTextArea = document.createElement('textarea');
                    tempTextArea.value = patientJoinLink;
                    document.body.appendChild(tempTextArea);
                    tempTextArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(tempTextArea);

                    showToast('Patient join link copied to clipboard!');
                };
            });

            document.querySelectorAll('.chat-toggle-button').forEach(button => {
                button.onclick = function() {
                    const patientUuid = this.dataset.patientUuid;
                    const patientName = this.dataset.patientName;

                    if (activeChatPatientUuid === patientUuid) {
                        chatSection.classList.add('hidden');
                        activeChatPatientUuid = null;
                        chatMessagesDiv.innerHTML = '';
                    } else {
                        activeChatPatientUuid = patientUuid;
                        chatPatientNameSpan.textContent = patientName;
                        chatMessagesDiv.innerHTML = '';
                        chatSection.classList.remove('hidden');
                        chatInput.focus();
                        unreadMessages[patientUuid] = 0;
                        updateChatAlert(patientUuid);
                        const history = patientChatHistories[patientUuid] || [];
                        history.forEach(msg => {
                            appendMessageToChatDiv(msg.sender, msg.message);
                        });
                    }
                    whiteboardSection.classList.add('hidden');
                    activeWhiteboardPatientUuid = null;
                    // When switching to chat, explicitly tell the server whiteboard is inactive for this patient
                    if (chatSocket.readyState === WebSocket.OPEN && patientUuid) {
                        chatSocket.send(JSON.stringify({
                            'type': 'whiteboard_toggle',
                            'patient_uuid': patientUuid,
                            'is_active': false
                        }));
                    }
                };
            });

            document.querySelectorAll('.whiteboard-toggle-button').forEach(button => {
                button.onclick = function() {
                    const patientUuid = this.dataset.patientUuid;
                    const patientName = this.dataset.patientName;

                    if (activeWhiteboardPatientUuid === patientUuid) {
                        whiteboardSection.classList.add('hidden');
                        activeWhiteboardPatientUuid = null;
                        // When closing whiteboard, explicitly tell the server it's inactive
                        if (chatSocket.readyState === WebSocket.OPEN && patientUuid) {
                            chatSocket.send(JSON.stringify({
                                'type': 'whiteboard_toggle',
                                'patient_uuid': patientUuid,
                                'is_active': false
                            }));
                        }
                    } else {
                        activeWhiteboardPatientUuid = patientUuid;
                        whiteboardPatientNameSpan.textContent = patientName;
                        whiteboardSection.classList.remove('hidden');
                        ctx.clearRect(0, 0, whiteboardCanvas.width, whiteboardCanvas.height);
                        resizeCanvas();
                        // When opening whiteboard, explicitly tell the server it's active and request history
                        if (chatSocket.readyState === WebSocket.OPEN && patientUuid) {
                            chatSocket.send(JSON.stringify({
                                'type': 'whiteboard_toggle',
                                'patient_uuid': patientUuid,
                                'is_active': true
                            }));
                            chatSocket.send(JSON.stringify({
                                'type': 'request_whiteboard_history',
                                'patient_uuid': patientUuid
                            }));
                        }
                    }
                    chatSection.classList.add('hidden');
                    activeChatPatientUuid = null;
                    chatMessagesDiv.innerHTML = '';
                };
            });
        }

        function appendMessageToChatDiv(sender, message) {
            const messageElement = document.createElement('div');
            messageElement.className = 'p-2 rounded-lg';

            const urlRegex = /(https?:\/\/[^\s]+)/g;
            let formattedMessage = message.replace(urlRegex, (url) => {
                return `<a href="${url}" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:underline">${url}</a>`;
            });

            if (sender === `Dr. {{ doctor.name }}`) {
                messageElement.classList.add('bg-blue-200', 'self-end', 'text-right');
                messageElement.innerHTML = `<span class="font-bold">You:</span> ${formattedMessage}`;
            } else {
                messageElement.classList.add('bg-gray-200', 'self-start');
                messageElement.innerHTML = `<span class="font-bold">${sender}:</span> ${formattedMessage}`;
            }
            chatMessagesDiv.appendChild(messageElement);
            chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
        }

        addPatientBtn.onclick = function() {
            const patientName = newPatientNameInput.value.trim();
            if (patientName) {
                showCustomModal(
                    'Add Patient',
                    `Add "${patientName}" to the waiting room?`,
                    () => {
                        chatSocket.send(JSON.stringify({
                            'type': 'add_patient',
                            'patient_name': patientName,
                            'patient_uuid': null
                        }));
                        newPatientNameInput.value = '';
                    },
                    () => {
                        console.log("Add patient cancelled.");
                    }
                );
            } else {
                showCustomModal('Input Required', 'Please enter a patient name.');
            }
        };

        function resizeCanvas() {
            const rect = whiteboardCanvas.getBoundingClientRect();
            whiteboardCanvas.width = rect.width;
            whiteboardCanvas.height = rect.height;
            ctx.clearRect(0, 0, whiteboardCanvas.width, whiteboardCanvas.height);
            if (activeWhiteboardPatientUuid && chatSocket.readyState === WebSocket.OPEN) {
                 chatSocket.send(JSON.stringify({
                    'type': 'request_whiteboard_history',
                    'patient_uuid': activeWhiteboardPatientUuid
                }));
            }
        }

        window.addEventListener('resize', resizeCanvas);

        whiteboardCanvas.addEventListener('mousedown', (e) => {
            if (!activeWhiteboardPatientUuid) return;
            isDrawing = true;
            [lastX, lastY] = [e.offsetX, e.offsetY];
            sendDrawingData('start', lastX, lastY, drawColor);
        });

        whiteboardCanvas.addEventListener('mousemove', (e) => {
            if (!isDrawing || !activeWhiteboardPatientUuid) return;
            sendDrawingData('draw', e.offsetX, e.offsetY, drawColor);
            draw(e.offsetX, e.offsetY, drawColor, lastX, lastY);
            [lastX, lastY] = [e.offsetX, e.offsetY];
        });

        whiteboardCanvas.addEventListener('mouseup', () => {
            isDrawing = false;
            if (activeWhiteboardPatientUuid) {
                sendDrawingData('end');
            }
        });

        whiteboardCanvas.addEventListener('mouseout', () => {
            if (isDrawing) {
                isDrawing = false;
                if (activeWhiteboardPatientUuid) {
                    sendDrawingData('end');
                }
            }
        });

        // Touch events for drawing
        whiteboardCanvas.addEventListener('touchstart', (e) => {
            if (!activeWhiteboardPatientUuid) return;
            e.preventDefault();
            const touch = e.touches[0];
            const rect = whiteboardCanvas.getBoundingClientRect();
            lastX = touch.clientX - rect.left;
            lastY = touch.clientY - rect.top;
            isDrawing = true;
            sendDrawingData('start', lastX, lastY, drawColor);
        });

        whiteboardCanvas.addEventListener('touchmove', (e) => {
            if (!isDrawing || !activeWhiteboardPatientUuid) return;
            e.preventDefault();
            const touch = e.touches[0];
            const rect = whiteboardCanvas.getBoundingClientRect();
            const currentX = touch.clientX - rect.left;
            const currentY = touch.clientY - rect.top;
            sendDrawingData('draw', currentX, currentY, drawColor);
            draw(currentX, currentY, drawColor, lastX, lastY);
            lastX = currentX;
            lastY = currentY;
        });

        whiteboardCanvas.addEventListener('touchend', () => {
            isDrawing = false;
            if (activeWhiteboardPatientUuid) {
                sendDrawingData('end');
            }
        });


        function draw(x, y, color, prevX, prevY) {
            ctx.strokeStyle = color;
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            ctx.beginPath();
            ctx.moveTo(prevX, prevY);
            ctx.lineTo(x, y);
            ctx.stroke();
        }

        function drawOnCanvas(data) {
            if (data.type === 'start') {
                ctx.strokeStyle = data.color;
                ctx.lineWidth = 2;
                ctx.lineCap = 'round';
                ctx.beginPath();
                ctx.moveTo(data.x, data.y);
                lastX = data.x;
                lastY = data.y;
            } else if (data.type === 'draw') {
                ctx.strokeStyle = data.color;
                ctx.lineWidth = 2;
                ctx.lineCap = 'round';
                ctx.lineTo(data.x, data.y);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(data.x, data.y);
                lastX = data.x;
                lastY = data.y;
            } else if (data.type === 'end') {
                ctx.closePath();
            } else if (data.type === 'clear') {
                ctx.clearRect(0, 0, whiteboardCanvas.width, whiteboardCanvas.height);
            }
        }

        function sendDrawingData(type, x = null, y = null, color = null) {
            if (chatSocket.readyState === WebSocket.OPEN && activeWhiteboardPatientUuid) {
                const data = {
                    type: type,
                    x: x,
                    y: y,
                    color: color
                };
                chatSocket.send(JSON.stringify({
                    'type': 'drawing_data',
                    'data': data,
                    'patient_uuid': activeWhiteboardPatientUuid
                }));
            }
        }

        // Color selection for whiteboard
        whiteboardColorButtons.forEach(button => {
            button.onclick = function() {
                drawColor = this.dataset.color;
                whiteboardColorButtons.forEach(btn => btn.classList.remove('border-blue-500', 'border-4'));
                this.classList.add('border-blue-500', 'border-4');
            };
        });

        // Clear whiteboard button
        clearWhiteboardBtn.onclick = function() {
            if (activeWhiteboardPatientUuid) {
                ctx.clearRect(0, 0, whiteboardCanvas.width, whiteboardCanvas.height);
                sendDrawingData('clear');
            }
        };

    </script>
{% endblock %}
