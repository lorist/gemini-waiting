{# waitingroom/templates/waitingroom/patient_waiting_room.html #}
{% extends 'base.html' %} {# This line tells Django to use base.html as the parent #}

{% block title %}Join Waiting Room - My App{% endblock %}

{% block content %}
    <div class="container mx-auto p-6 card">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">Join a Doctor's Waiting Room</h1>

        <div class="space-y-6" id="joinFormSection">
            <div>
                <label for="doctorSelect" class="block text-gray-700 text-sm font-bold mb-2">Select Doctor:</label>
                <select id="doctorSelect" class="form-input">
                    <!-- Doctors will be loaded here dynamically by Django -->
                    <option value="">-- Select a Doctor --</option>
                    {% for doctor in doctors %}
                        <option value="{{ doctor.id }}">{{ doctor.name }}</option>
                    {% empty %}
                        <option value="">No doctors available</option>
                    {% endfor %}
                </select>
            </div>

            <div>
                <label for="patientName" class="block text-gray-700 text-sm font-bold mb-2">Your Name:</label>
                <input type="text" id="patientName" placeholder="Enter your name" class="form-input">
            </div>

            <button id="joinQueueBtn" class="w-full bg-blue-600 text-white px-6 py-3 rounded-md font-semibold hover:bg-blue-700 transition duration-200 ease-in-out shadow-md">Join Queue</button>

            <div id="messageArea" class="mt-4 p-3 rounded-md text-center hidden"></div>
        </div>

        <div id="patientStatusSection" class="hidden mt-8 p-6 card border border-blue-200">
            <h2 class="text-2xl font-bold text-blue-700 mb-4 text-center">Your Queue Status</h2>
            <p class="text-lg text-gray-800 mb-2">Hello, <span id="myPatientName" class="font-semibold"></span>!</p>
            <p class="text-lg text-gray-800 mb-4">You are in Dr. <span id="myDoctorName" class="font-semibold"></span>'s queue.</p>
            <div class="flex items-center justify-center space-x-2">
                <p class="text-xl font-bold text-gray-900">Current Status:</p>
                <span id="myStatus" class="py-2 px-4 rounded-full text-lg font-bold">Loading...</span>
            </div>
            <p class="text-sm text-gray-600 mt-4 text-center" id="statusMessage">Waiting for updates...</p>
            <p class="text-xs text-gray-400 mt-2 text-center">Your ID: <span id="myPatientUuid"></span></p>
            <p class="text-sm text-gray-600 mt-2 text-center" id="myGuestPinDisplay">Guest PIN: <span class="font-bold"></span></p>

            <!-- Chat Section for Patient -->
            <div id="patientChatSection" class="mt-8 p-4 bg-gray-50 rounded-md">
                <h3 class="text-xl font-bold text-gray-800 mb-3 text-center">Chat with Dr. <span id="chatDoctorName"></span></h3>
                <div id="patientChatMessages" class="bg-white p-3 rounded-md h-48 overflow-y-auto mb-3 space-y-2 border border-gray-200">
                    <!-- Patient chat messages will appear here -->
                </div>
                <div class="flex gap-2">
                    <input type="text" id="patientChatInput" placeholder="Type your message..." class="flex-grow p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button id="sendPatientChatBtn" class="bg-blue-600 text-white px-3 py-2 rounded-md font-semibold hover:bg-blue-700 transition duration-200 ease-in-out shadow-md">Send</button>
                </div>
            </div>

        </div>

        <!-- Custom Modal for Alerts/Confirmations (reused for Pexip prompt) -->
        <div id="customModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden">
            <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full">
                <h3 id="modalTitle" class="text-lg font-bold mb-4"></h3>
                <p id="modalMessage" class="mb-6"></p>
                <div class="flex justify-end space-x-3">
                    <button id="modalCancelBtn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition duration-200 hidden">Cancel</button>
                    <button id="modalConfirmBtn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition duration-200">OK</button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
    <script>
        const doctorSelect = document.getElementById('doctorSelect');
        const patientNameInput = document.getElementById('patientName');
        const joinQueueBtn = document.getElementById('joinQueueBtn');
        const messageArea = document.getElementById('messageArea');

        const joinFormSection = document.getElementById('joinFormSection');
        const patientStatusSection = document.getElementById('patientStatusSection');
        const myPatientNameSpan = document.getElementById('myPatientName');
        const myDoctorNameSpan = document.getElementById('myDoctorName');
        const myStatusSpan = document.getElementById('myStatus');
        const statusMessageP = document.getElementById('statusMessage');
        const myPatientUuidSpan = document.getElementById('myPatientUuid');
        const myGuestPinDisplay = document.getElementById('myGuestPinDisplay');

        // Modal elements
        const customModal = document.getElementById('customModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');
        const modalConfirmBtn = document.getElementById('modalConfirmBtn');
        const modalCancelBtn = document.getElementById('modalCancelBtn');

        // Chat elements for patient
        const patientChatSection = document.getElementById('patientChatSection');
        const chatDoctorNameSpan = document.getElementById('chatDoctorName');
        const patientChatMessagesDiv = document.getElementById('patientChatMessages');
        const patientChatInput = document.getElementById('patientChatInput');
        const sendPatientChatBtn = document.getElementById('sendPatientChatBtn');


        let patientSocket = null;
        let currentPatientName = '';
        let currentDoctorId = '';
        let currentDoctorName = '';
        let currentPatientUuid = '';
        let currentGuestPin = '';
        let currentHostPin = '';
        let hasJoinedConfirmed = false;

        // Pexip settings passed from Django context
        const PEXIP_ADDRESS = "{{ pexip_address }}";
        const PEXIP_PATH = "{{ pexip_path }}";

        const PATIENT_DATA_KEY = 'patientData';

        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        function savePatientData() {
            const data = {
                name: currentPatientName,
                uuid: currentPatientUuid,
                doctorId: currentDoctorId,
                doctorName: currentDoctorName,
                guestPin: currentGuestPin,
                hostPin: currentHostPin
            };
            localStorage.setItem(PATIENT_DATA_KEY, JSON.stringify(data));
        }

        function loadPatientData() {
            const data = localStorage.getItem(PATIENT_DATA_KEY);
            if (data) {
                return JSON.parse(data);
            }
            return null;
        }

        function clearPatientData() {
            localStorage.removeItem(PATIENT_DATA_KEY);
        }

        function showCustomModal(title, message, onConfirm = null, onCancel = null, confirmText = 'OK', cancelText = 'Cancel') {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modalConfirmBtn.textContent = confirmText;
            modalCancelBtn.textContent = cancelText;

            customModal.classList.remove('hidden');

            modalConfirmBtn.onclick = () => {
                customModal.classList.add('hidden');
                if (onConfirm) onConfirm();
            };

            if (onCancel) {
                modalCancelBtn.classList.remove('hidden');
                modalCancelBtn.onclick = () => {
                    customModal.classList.add('hidden');
                    onCancel();
                };
            } else {
                modalCancelBtn.classList.add('hidden');
            }
        }

        function displayMessage(message, type = 'info') {
            messageArea.textContent = message;
            messageArea.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700', 'bg-blue-100', 'text-blue-700');
            if (type === 'error') {
                messageArea.classList.add('bg-red-100', 'text-red-700');
            } else if (type === 'success') {
                messageArea.classList.add('bg-green-100', 'text-green-700');
            } else { // info
                messageArea.classList.add('bg-blue-100', 'text-blue-700');
            }
        }

        function updatePatientStatusUI(status) {
            myStatusSpan.textContent = status;
            myStatusSpan.className = 'py-2 px-4 rounded-full text-lg font-bold'; // Reset classes
            statusMessageP.textContent = `Your status was last updated at ${new Date().toLocaleTimeString()}.`;

            // Apply status-specific styling
            if (status === 'Waiting') {
                myStatusSpan.classList.add('bg-yellow-300', 'text-yellow-800');
                statusMessageP.textContent = `You are currently waiting in the queue.`;
                myGuestPinDisplay.classList.add('hidden'); // Hide guest PIN
                patientChatSection.classList.remove('hidden'); // Show chat section
            } else if (status === 'In Progress') {
                myStatusSpan.classList.add('bg-blue-300', 'text-blue-800');
                myGuestPinDisplay.querySelector('span').textContent = currentGuestPin;
                myGuestPinDisplay.classList.remove('hidden'); // Show guest PIN
                statusMessageP.textContent = `You are currently being seen by the doctor. Please join the call.`;
                patientChatSection.classList.remove('hidden'); // Show chat section

                showCustomModal(
                    'Join Doctor\'s Room',
                    `Your appointment is now in progress.  Would you like to join the doctor\'s virtual room?`,
                    () => {
                        const pexipUrl = `https://${PEXIP_ADDRESS}/${PEXIP_PATH}/m/?conference=${currentPatientUuid}&name=${encodeURIComponent(currentPatientName)}&role=guest&pin=${currentGuestPin}`;
                        window.open(pexipUrl, '_blank');
                        statusMessageP.textContent = `You are in the call with Dr. ${currentDoctorName}.`;
                    },
                    () => {
                        statusMessageP.textContent = `You chose not to join the call at this time. Please wait for further instructions.`;
                    },
                    'Join Call',
                    'Later'
                );
            } else if (status === 'In Call') { // NEW: Handle 'In Call' status
                myStatusSpan.classList.add('bg-green-500', 'text-white');
                myGuestPinDisplay.querySelector('span').textContent = currentGuestPin;
                myGuestPinDisplay.classList.remove('hidden');
                statusMessageP.textContent = `You are currently in the call with Dr. ${currentDoctorName}.`;
                patientChatSection.classList.remove('hidden'); // Show chat section
                // No modal here, as they are already in the call
            }
            else if (status === 'Done') {
                myStatusSpan.classList.add('bg-green-300', 'text-green-800');
                statusMessageP.textContent = `Your appointment is complete.`;
                myGuestPinDisplay.classList.add('hidden');
                patientChatSection.classList.add('hidden'); // Hide chat section
                showCustomModal(
                    'Appointment Complete',
                    'Your appointment has been marked as complete. You will now be redirected to the join page.',
                    () => {
                        if (patientSocket) patientSocket.close();
                        clearPatientData();
                        window.location.href = '/join-queue/';
                    }
                );
            } else if (status === 'Cancelled' || status === 'Left Call') { // NEW: Handle 'Left Call' status
                myStatusSpan.classList.add('bg-red-300', 'text-red-800');
                statusMessageP.textContent = `Your appointment has ended or been cancelled.`;
                myGuestPinDisplay.classList.add('hidden');
                patientChatSection.classList.add('hidden'); // Hide chat section
                showCustomModal(
                    'Appointment Ended',
                    'Your appointment has ended or been cancelled. You will now be redirected to the join page.',
                    () => {
                        if (patientSocket) patientSocket.close();
                        clearPatientData();
                        window.location.href = '/join-queue/';
                    }
                );
            } else {
                myStatusSpan.classList.add('bg-gray-300', 'text-gray-800');
                myGuestPinDisplay.classList.add('hidden');
                patientChatSection.classList.add('hidden'); // Hide chat section
            }
        }

        function displayPatientChatMessage(sender, message, patientUuid) {
            // Check if the message is for this patient (based on their UUID)
            if (currentPatientUuid === patientUuid) {
                // Use the helper function to append messages, which now handles link detection
                appendMessageToPatientChatDiv(sender, message);
            }
        }

        // Helper function to append messages to the patient chat div, with link detection
        function appendMessageToPatientChatDiv(sender, message) {
            const messageElement = document.createElement('div');
            messageElement.className = 'p-2 rounded-lg';

            // Regex to find URLs
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            let formattedMessage = message.replace(urlRegex, (url) => {
                return `<a href="${url}" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:underline">${url}</a>`;
            });

            if (sender === currentPatientName) { // Message sent by patient themselves
                messageElement.classList.add('bg-blue-200', 'self-end', 'text-right');
                messageElement.innerHTML = `<span class="font-bold">You:</span> ${formattedMessage}`;
            } else { // Message sent by doctor (or other participant, though unlikely in this setup)
                messageElement.classList.add('bg-gray-200', 'self-start');
                messageElement.innerHTML = `<span class="font-bold">${sender}:</span> ${formattedMessage}`;
            }
            patientChatMessagesDiv.appendChild(messageElement);
            patientChatMessagesDiv.scrollTop = patientChatMessagesDiv.scrollHeight; // Scroll to bottom
        }


        sendPatientChatBtn.onclick = function() {
            const message = patientChatInput.value.trim();
            if (message && patientSocket && patientSocket.readyState === WebSocket.OPEN) {
                patientSocket.send(JSON.stringify({
                    'type': 'chat_message',
                    'sender': currentPatientName,
                    'message': message,
                    'patient_uuid': currentPatientUuid // Send patient UUID with message
                }));
                patientChatInput.value = ''; // Clear input
            }
        };

        patientChatInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendPatientChatBtn.click();
            }
        });


        function connectPatientWebSocket() {
            joinFormSection.classList.add('hidden');
            patientStatusSection.classList.remove('hidden');
            myPatientNameSpan.textContent = currentPatientName;
            myDoctorNameSpan.textContent = currentDoctorName;
            myPatientUuidSpan.textContent = currentPatientUuid;
            chatDoctorNameSpan.textContent = currentDoctorName; // Set doctor name for chat
            updatePatientStatusUI('Waiting');

            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws/waiting_room/${currentDoctorId}/`;
            patientSocket = new WebSocket(wsUrl);

            patientSocket.onopen = function(e) {
                console.log(`Patient WebSocket opened for doctor ${currentDoctorId}. Sending add_patient message.`);
                patientSocket.send(JSON.stringify({
                    'type': 'add_patient',
                    'patient_name': currentPatientName,
                    'patient_uuid': currentPatientUuid
                }));
                displayMessage(`You have joined Dr. ${currentDoctorName}'s queue.`, 'success');
                savePatientData();
            };

            patientSocket.onmessage = function(e) {
                const data = JSON.parse(e.data);
                console.log("Patient received message:", data);

                if (data.type === 'waiting_list') {
                    const myEntry = data.data.find(entry =>
                        entry.patient_uuid === currentPatientUuid &&
                        entry.doctor_id == currentDoctorId
                    );

                    if (myEntry) {
                        hasJoinedConfirmed = true;
                        currentGuestPin = myEntry.guest_pin;
                        currentHostPin = myEntry.host_pin;
                        updatePatientStatusUI(myEntry.status);
                    } else {
                        // If patient entry is no longer in the active list (e.g., Done, Cancelled, Left Call)
                        if (hasJoinedConfirmed) {
                            if (myStatusSpan.textContent === 'Waiting' || myStatusSpan.textContent === 'In Progress' || myStatusSpan.textContent === 'In Call') {
                                updatePatientStatusUI('Done'); // Default to Done if entry not found
                            }
                        }
                    }
                } else if (data.type === 'chat_message') { // NEW: Handle incoming chat messages
                    displayPatientChatMessage(data.sender, data.message, data.patient_uuid);
                } else if (data.type === 'error') {
                    showCustomModal('Error', data.message);
                }
            };

            patientSocket.onclose = function(e) {
                console.error('Patient WebSocket closed unexpectedly:', e);
                statusMessageP.textContent = "Disconnected from updates. Please refresh.";
                if (myStatusSpan.textContent !== 'Done' && myStatusSpan.textContent !== 'Cancelled' && myStatusSpan.textContent !== 'Left Call') {
                    showCustomModal('Disconnected', 'The connection to the waiting room updates has been lost. Please refresh the page.');
                }
            };

            patientSocket.onerror = function(e) {
                console.error('Patient WebSocket error:', e);
                statusMessageP.textContent = "Error connecting to updates. Please refresh.";
                showCustomModal('Connection Error', 'An error occurred with the WebSocket connection. Please refresh the page.');
            };
        }

        // Removed the beforeunload event listener as server-side handling is more reliable.


        joinQueueBtn.onclick = function() {
            const selectedDoctorId = doctorSelect.value;
            const patientName = patientNameInput.value.trim();
            const selectedDoctorName = doctorSelect.options[doctorSelect.selectedIndex].textContent;

            if (!selectedDoctorId) {
                showCustomModal('Selection Required', 'Please select a doctor.');
                return;
            }
            if (!patientName) {
                showCustomModal('Input Required', 'Please enter your name.');
                return;
            }

            showCustomModal(
                'Confirm Join Queue',
                `Are you sure you want to join Dr. ${selectedDoctorName}'s queue as "${patientName}"?`,
                () => {
                    currentPatientName = patientName;
                    currentDoctorId = selectedDoctorId;
                    currentDoctorName = selectedDoctorName;
                    currentPatientUuid = generateUUID();
                    hasJoinedConfirmed = false;
                    currentGuestPin = '';
                    currentHostPin = '';

                    connectPatientWebSocket();
                    patientNameInput.value = '';
                },
                () => {
                    console.log("Join queue cancelled.");
                }
            );
        };

        document.addEventListener('DOMContentLoaded', () => {
            const savedPatientData = loadPatientData();
            if (savedPatientData) {
                currentPatientName = savedPatientData.name;
                currentPatientUuid = savedPatientData.uuid;
                currentDoctorId = savedPatientData.doctorId;
                currentDoctorName = savedPatientData.doctorName;
                currentGuestPin = savedPatientData.guestPin || '';
                currentHostPin = savedPatientData.hostPin || '';
                hasJoinedConfirmed = true;
                showCustomModal(
                    'Resume Session',
                    `Welcome back, ${currentPatientName}! Do you want to resume your session with Dr. ${currentDoctorName}?`,
                    () => {
                        connectPatientWebSocket();
                    },
                    () => {
                        clearPatientData();
                        joinFormSection.classList.remove('hidden');
                    }
                );
            } else {
                joinFormSection.classList.remove('hidden');
            }
        });
    </script>
{% endblock %}
